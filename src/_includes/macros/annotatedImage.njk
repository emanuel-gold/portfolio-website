{% macro annotatedImage(src, alt, params = {}) %}
{# options:
   params.ratio      -> string aspect ratio like "16 / 9" (optional)
   params.className  -> extra classes on <figure> (optional)
   params.figcaption -> overall figcaption HTML/text (optional)
   params.callouts   -> array of { x, y, text|html, side, label }
      - x, y: numbers 0â€“100 (percent from left/top of image)
      - side: "left" to place caption/line to the left (default right)
      - text: plain text for caption
      - html: (optional) HTML for caption; if set, used instead of text
      - label: (optional) screen-reader label for the marker
#}

{% set ratio = params.ratio %}
{% set figcaption = params.figcaption or "" %}
{% set callouts = params.callouts or [] %}

{% set figureClass = "annotated" %}
{% if params.className %}
  {% set figureClass = figureClass + " " + params.className %}
{% endif %}

<figure class="{{ figureClass }}"{% if ratio %} style="aspect-ratio: {{ ratio }}"{% endif %}>
  <img src="{{ src }}" alt="{{ alt }}" loading="lazy" decoding="async">

  {% for c in callouts %}
    {%- set isLeft = c.side == "left" -%}
    {%- set markerLabel = (c.label or c.text or "Image detail") | striptags -%}
    <details class="annotated__callout{% if isLeft %} annotated__callout--left{% endif %}" style="--x:{{ c.x }}%; --y:{{ c.y }}%">
      <summary class="annotated__marker" aria-label="{{ markerLabel }}">
        <span aria-hidden="true"></span>
      </summary>
      <span class="annotated__leader" aria-hidden="true"></span>
      <p class="annotated__caption">
        {%- if c.html -%}{{ c.html | safe }}{%- else -%}{{ c.text }}{%- endif -%}
      </p>
    </details>
  {% endfor %}

  {% if figcaption %}
    <figcaption class="annotated__figcaption">{{ figcaption | safe }}</figcaption>
  {% endif %}
</figure>
{% endmacro %}
